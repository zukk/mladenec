   # Индекс по товарам мой
   ###################################################
   source goods_zukk
   {
    type        = mysql
    sql_host    = localhost
    sql_user    = root
    sql_pass    = 777888
    sql_db      = zukk

       sql_query_pre   = SET NAMES utf8

       sql_query    = \
           SELECT id, @rn := @rn +1 AS alphabet, grouped, hit, shop_id, section_id, group_id, price, brand_id, popularity, s_popularity, x, discount, superprice, short_name, words, nt \
           FROM ( \
               (SELECT  g.id, 0 as grouped, IF(h.good_id IS NOT NULL, 1, 0) as hit, IF(gr.vitrina = 'mladenec', 1, IF(gr.vitrina = 'ogurchik', 2, 0)) as shop_id, \
                       g.section_id, g.group_id, g.price*100 AS price, g.brand_id, IF( g.order > 0, 100000+g.order, g.popularity) AS popularity, g.popularity AS s_popularity, \
                       g.qty != 0 AS x, IF (g.old_price > 0 , 1, 0) as discount, p.superprice, \
                   CONCAT( g.group_name, ' ', g.name ) AS short_name, \
                   CONCAT( s.name, ' ', b.name, ' ', g.code COLLATE utf8_general_ci, ' ', p.search, ' ', b.search_words ) AS words, UNIX_TIMESTAMP( p.new_till ) AS nt \
               FROM z_good g \
                   JOIN z_good_prop p ON ( g.id = p.id ) \
                   JOIN z_group gr ON ( g.group_id = gr.id AND g.active = 1 ) \
                   JOIN z_brand b ON ( g.brand_id = b.id AND b.active = 1 ) \
            LEFT JOIN z_hit h ON (g.id = h.good_id) \
               INNER JOIN z_section s ON ( g.section_id = s.id AND s.active = 1 ) \
                   WHERE g.show = 1 AND gr.good = 0 \
               ) \
               UNION \
               (SELECT  gr.good_id, 1, IF(h.good_id IS NOT NULL, 1, 0) as hit, IF(gr.vitrina = 'mladenec', 1, IF(gr.vitrina = 'ogurchik', 2, 0)) as shop_id, \
                       gr.section_id, g.group_id, MIN(g.price)*100 AS price, g.brand_id, IF( g.order > 0, 100000+g.order, g.popularity) AS popularity, g.popularity AS s_popularity,\
                       g.qty != 0 AS x, IF (g.old_price > 0 , 1, 0) as discount, p.superprice, \
                   CONCAT( g.group_name, ' ', GROUP_CONCAT(g.name) ) AS short_name, \
                   CONCAT( s.name, ' ', b.name, ' ', GROUP_CONCAT(CONCAT(g.code COLLATE utf8_general_ci, ' ', p.search)), ' ', b.search_words ) AS words, UNIX_TIMESTAMP( MAX(p.new_till) ) AS nt \
               FROM z_good g \
                   JOIN z_good_prop p ON ( g.id = p.id ) \
                   JOIN z_group gr ON ( g.group_id = gr.id AND g.active = 1 ) \
                   JOIN z_brand b ON ( g.brand_id = b.id AND b.active = 1 ) \
            LEFT JOIN z_hit h ON (g.id = h.good_id)  \
               INNER JOIN z_section s ON ( g.section_id = s.id AND s.active = 1 ) \
                   WHERE g.show = 1 AND gr.good = 1 AND g.qty != 0 \
                   GROUP BY gr.id \
               ) \
               ORDER BY short_name \
           ) AS t, (SELECT @rn :=0) AS rn

       sql_attr_multi = uint fvalue from query; \
           SELECT gf.good_id, gf.value_id FROM z_good_filter gf  \
               INNER JOIN z_good g ON (g.id = gf.good_id AND g.show = 1) \
               INNER JOIN z_group gr ON (gr.id = g.group_id AND gr.good = 0) \
           UNION \
           SELECT gr.good_id, gf.value_id FROM z_good_filter gf \
               INNER JOIN z_good g ON (g.id = gf.good_id AND g.show = 1) \
               INNER JOIN z_group gr ON (gr.id = g.group_id AND gr.good = 1)

        sql_attr_multi = uint action_id from query; \
            SELECT ag.good_id, ag.action_id FROM z_action_good ag \
                INNER JOIN z_action a ON (a.id = action_id) \
                INNER JOIN z_good g ON (g.id = ag.good_id AND g.show = 1) \
                INNER JOIN z_group gr ON (gr.id = g.group_id AND gr.good = 0) \
                WHERE a.`show_goods` = 1 AND a.active = 1 \
            UNION \
            SELECT gr.good_id, action_id FROM z_action_good ag \
                INNER JOIN z_action a ON (a.id = action_id) \
                INNER JOIN z_good g ON (g.id = ag.good_id AND g.show = 1) \
                INNER JOIN z_group gr ON (gr.id = g.group_id AND gr.good = 1) \
            WHERE a.`show_goods` = 1 AND a.active = 1

       sql_attr_bool = x
       sql_attr_bool = discount
       sql_attr_bool = grouped
       sql_attr_bool = superprice
       sql_attr_bool = hit
       sql_attr_uint = shop_id
       sql_attr_uint = alphabet
       sql_attr_uint = popularity
       sql_attr_uint = s_popularity
       sql_attr_uint = group_id
       sql_attr_uint = section_id
       sql_attr_uint = brand_id
       sql_attr_uint = price
       sql_attr_uint = nt
   }

# Настройка индексатора
###################################################
indexer
{
    mem_limit       = 128M
    write_buffer    = 8M
}

index goods_zukk
{
    source = goods_zukk
    path = /home/pks/sites/mladenec.dev/application/cache/goods_zukk
    charset_type = utf-8


    morphology = stem_enru
    min_word_len = 2
    html_remove_elements = style, script
    html_strip = 1
}

# Настройка searchd
###################################################
searchd
{
    # Адрес сервера
    listen = localhost:9306:mysql41

    # Лог
    log = /home/pks/sites/logs/sphinx/searchd.log

    # Лог запросов
    query_log = /home/pks/sites/logs/sphinx/query.log

    # Таймаут на соединение с сервером (в секундах). При истечении времени происходит обрыв
    read_timeout = 5

    # Максимальное кол-во потомков от процесса
    max_children = 30

    # Путь до pid-файла
    pid_file = /home/pks/sites/logs/sphinx/searchd.pid

    # Максимальное кол-во результатов выдачи
    max_matches = 1000

    thread_stack = 256K

    dist_threads = 3
}
